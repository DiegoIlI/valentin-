<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>üíò 14 de Febrero</title>
  <style>
    :root{ --bg:#05060a; --pink:#ff4fd8; --text:#e9f0ff; }
    html,body{height:100%;margin:0;background:var(--bg);overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    canvas{position:fixed;inset:0;width:100%;height:100%;}

    .ui{
      position:fixed;left:0;right:0;top:0;z-index:10;
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 14px;gap:10px;pointer-events:none;
      color:rgba(233,240,255,.9);
      text-shadow:0 2px 10px rgba(0,0,0,.6);
      font-weight:800;
    }
    .pill{
      pointer-events:auto;backdrop-filter:blur(10px);
      background:rgba(10,12,20,.45);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;border-radius:999px;
      display:flex;align-items:center;gap:10px;
      box-shadow:0 10px 25px rgba(0,0,0,.25);
    }
    .pill input{
      width:150px;max-width:46vw;border:none;outline:none;background:transparent;
      color:var(--text);font-weight:900;
    }
    .pill button{
      border:none;outline:none;cursor:pointer;color:var(--text);
      background:rgba(255,79,216,.18);
      border:1px solid rgba(255,79,216,.35);
      padding:8px 10px;border-radius:999px;font-weight:900;
    }
    .hint{pointer-events:none;opacity:.75;font-size:12px;line-height:1.2;text-align:right;font-weight:800;}
    @media (max-width:520px){ .hint{display:none;} .pill input{width:120px;} }

    .finalOverlay{
      position:fixed; inset:0; z-index:9;
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none;
      transition:opacity 900ms ease;
      padding:clamp(12px,3vw,28px);
      background:rgba(0,0,0,.20);
    }
    .finalOverlay.show{ opacity:1; pointer-events:auto; }

    .finalCard{
      position:relative;
      width:min(520px, 92vw);
      height:min(820px, 82vh);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,12,20,.35);
      backdrop-filter: blur(8px);
    }
    .photoArea{
      position:absolute; left:0; right:0; top:0; height:72%;
      display:flex; align-items:center; justify-content:center;
      padding:14px 14px 8px;
      background:transparent;
    }
    .finalImg{
      width:100%; height:100%;
      object-fit:contain; object-position:center;
      border-radius:14px;
      background:transparent;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
    }
    .textArea{
      position:absolute; left:0; right:0; bottom:0; height:28%;
      display:flex; align-items:center; justify-content:center;
      padding:18px 20px 22px;
    }
    .quote{
      text-align:center;
      color:rgba(255,255,255,.96);
      font-weight:900;
      line-height:1.25;
      font-size:clamp(16px, 2.0vw, 22px);
      text-shadow:0 3px 18px rgba(0,0,0,.85), 0 1px 3px rgba(0,0,0,.85);
      opacity:0; transform:translateY(10px);
      transition:opacity 900ms ease, transform 900ms ease;
      max-width:38ch;
    }
    .finalOverlay.show .quote{opacity:1;transform:translateY(0);}
    .closeTip{
      position:absolute; left:50%; bottom:10px; transform:translateX(-50%);
      font-size:12px; font-weight:900;
      color:rgba(233,240,255,.9);
      text-shadow:0 2px 10px rgba(0,0,0,.7);
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
      pointer-events:none;
    }

    .musicBtn{
      pointer-events:auto;
      margin-left:6px;
      border:none; outline:none; cursor:pointer;
      color:var(--text);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      min-width:42px;
    }
    .musicBtn.on{
      background:rgba(255,79,216,.18);
      border-color:rgba(255,79,216,.35);
    }
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <!-- ‚úÖ Tu archivo: musica.mp3 (en la misma carpeta que index.html) -->
  <audio id="bgm" preload="auto" loop playsinline webkit-playsinline>
    <source src="musica.mp3" type="audio/mpeg" />
  </audio>

  <div class="ui">
    <div class="pill">
      <span>Para:</span>
      <input id="name" value="Misita" maxlength="24" />
      <button id="go">‚ñ∂</button>
      <button id="musicBtn" class="musicBtn" title="M√∫sica">üîá</button>
    </div>
    <div class="hint">Toca/clic para <b>reiniciar</b><br/>y ver la animaci√≥n otra vez</div>
  </div>

  <div class="finalOverlay" id="finalOverlay">
    <div class="finalCard">
      <div class="photoArea">
        <img class="finalImg" id="finalImg" alt="Imagen final" />
      </div>
      <div class="textArea">
        <div class="quote" id="quote1">
          ‚ÄúY jam√°s olvides que el brillo tuyo es tan intenso como el de mil soles‚Äù
        </div>
      </div>
      <div class="closeTip">Toca/clic para reiniciar ‚ú®</div>
    </div>
  </div>

<script>
(() => {
  const FINAL_IMAGE_SRC = "final.png";  // cambia si tu imagen final tiene otro nombre
  const MUSIC_SRC = "musica.mp3";       // ‚úÖ tu archivo

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:true });

  const finalOverlay = document.getElementById('finalOverlay');
  const finalImg = document.getElementById('finalImg');
  finalImg.src = FINAL_IMAGE_SRC;

  // ===== AUDIO (FIX iOS/Android) =====
  const bgm = document.getElementById('bgm');
  const musicBtn = document.getElementById('musicBtn');

  let audioUnlocked = false;
  let wantsMusic = false; // si el usuario quiere m√∫sica encendida

  // WebAudio unlock (muy √∫til en iOS)
  let AC = null, audioCtx = null, srcNode = null;

  function ensureAudioContext(){
    if(audioCtx) return;
    AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    audioCtx = new AC();
    try{
      srcNode = audioCtx.createMediaElementSource(bgm);
      srcNode.connect(audioCtx.destination);
    }catch(e){
      // si ya fue creado antes, ignore
    }
  }

  async function unlockAudio(){
    if(audioUnlocked) return;
    ensureAudioContext();

    try{
      if(audioCtx && audioCtx.state === "suspended"){
        await audioCtx.resume();
      }
      // truco: intentar reproducir muy breve y pausar, para ‚Äúhabilitar‚Äù audio
      bgm.muted = true;
      bgm.src = MUSIC_SRC; // asegura ruta
      await bgm.play();
      bgm.pause();
      bgm.currentTime = 0;
      bgm.muted = false;

      audioUnlocked = true;
    }catch(e){
      // si falla aqu√≠, igual intentaremos al pr√≥ximo toque
      audioUnlocked = false;
    }
  }

  function setMusicUI(on){
    if(on){
      musicBtn.classList.add('on');
      musicBtn.textContent = 'üîä';
    }else{
      musicBtn.classList.remove('on');
      musicBtn.textContent = 'üîá';
    }
  }

  async function playMusic(){
    wantsMusic = true;
    setMusicUI(true);

    await unlockAudio();

    try{
      bgm.volume = 0.65;
      bgm.muted = false;
      await bgm.play();
    }catch(e){
      // Si a√∫n est√° bloqueado, quedar√° ‚Äúqueriendo‚Äù m√∫sica y se intentar√° en el pr√≥ximo gesto.
    }
  }

  function pauseMusic(){
    wantsMusic = false;
    setMusicUI(false);
    try{ bgm.pause(); }catch(e){}
  }

  async function toggleMusic(){
    if(bgm.paused){
      await playMusic();
    }else{
      pauseMusic();
    }
  }

  musicBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    toggleMusic();
  });

  // ‚úÖ Si el usuario ya quer√≠a m√∫sica y el navegador la bloque√≥,
  // al siguiente toque lo volvemos a intentar.
  async function gestureAudioKick(){
    if(wantsMusic && bgm.paused){
      await playMusic();
    }else{
      await unlockAudio();
    }
  }

  // ===== ANIMACI√ìN (igual que antes, resumida pero completa) =====
  const CFG = {
    matrixFont: 16, matrixSpeed: 1.10, matrixFade: 0.085,
    matrixColor: 'rgba(255,79,216,0.85)', glowColor:'rgba(255,79,216,0.55)',
    particleColor:'rgba(255,255,255,0.95)', particleRadius:1.2,
    settleSpeed:0.095, disperseForce:3.6,
    d1:2.2,d2:2.2,d3:2.2, dy:2.0,da:2.0,dm:2.0,ds:2.6,
    heartHold:3.6, buildTime:1.8
  };

  let W=0,H=0,DPR=1;
  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(innerWidth);
    H = Math.floor(innerHeight);
    canvas.width = Math.floor(W*DPR);
    canvas.height = Math.floor(H*DPR);
    canvas.style.width = W+'px';
    canvas.style.height = H+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    matrixInit();
  }
  addEventListener('resize', resize, {passive:true});

  const chars = ('01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé' +
                 '„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥' +
                 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' +
                 '0123456789@#$%&*+-=?<>').split('');
  let columns=0, drops=[];
  function matrixInit(){
    columns = Math.ceil(W / CFG.matrixFont);
    drops = new Array(columns).fill(0).map(()=>Math.random()*H);
  }
  function drawMatrix(){
    ctx.fillStyle = `rgba(5,6,10,${CFG.matrixFade})`;
    ctx.fillRect(0,0,W,H);

    ctx.font = `${CFG.matrixFont}px monospace`;
    for(let i=0;i<columns;i++){
      const x = i*CFG.matrixFont;
      const y = drops[i];
      const ch = chars[(Math.random()*chars.length)|0];

      ctx.fillStyle = CFG.matrixColor;
      ctx.shadowColor = CFG.glowColor;
      ctx.shadowBlur = 12;
      ctx.fillText(ch, x, y);

      drops[i] += CFG.matrixFont * CFG.matrixSpeed;
      if(drops[i] > H + Math.random()*400) drops[i] = -Math.random()*300;
    }
    ctx.shadowBlur = 0;
  }

  const off = document.createElement('canvas');
  const ox = off.getContext('2d');

  function resetOffscreen(){
    off.width = W; off.height = H;
    ox.setTransform(1,0,0,1,0,0);
    ox.clearRect(0,0,W,H);
  }

  function makeTarget(drawFn, density=1.0){
    resetOffscreen();
    drawFn(ox);
    const img = ox.getImageData(0,0,W,H).data;
    const pts = [];
    const base = Math.max(2, Math.round(Math.min(W,H)/240));
    const step = Math.max(2, Math.round(base / density));
    for(let y=0;y<H;y+=step){
      for(let x=0;x<W;x+=step){
        const a = img[(y*W + x)*4 + 3];
        if(a > 40) pts.push({x,y});
      }
    }
    return pts;
  }

  function drawCenteredText(text, size, y, color='white', weight=900){
    ox.save();
    ox.textAlign='center';
    ox.textBaseline='middle';
    ox.fillStyle=color;
    ox.font=`${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ox.fillText(text, W/2, y);
    ox.restore();
  }

  function stampHeart(ox, x, y, s, rot=0){
    ox.save();
    ox.translate(x,y);
    ox.rotate(rot);
    ox.scale(s,s);
    ox.beginPath();
    ox.moveTo(0, 0.35);
    ox.bezierCurveTo(-0.65, -0.20, -0.65, -0.85, 0, -0.55);
    ox.bezierCurveTo( 0.65, -0.85,  0.65, -0.20, 0,  0.35);
    ox.closePath();
    ox.fill();
    ox.restore();
  }
  function drawHeartOfHearts(cx, cy, scale){
    ox.save();
    ox.translate(cx, cy);
    const isMobile = W < 700;
    const count = isMobile ? 220 : 320;
    const s = isMobile ? 10 : 9;
    ox.fillStyle = 'rgba(255,79,216,.95)';
    for(let i=0;i<count;i++){
      const t = (i/(count-1))*Math.PI*2;
      const x = 16*Math.pow(Math.sin(t),3);
      const y = -(13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
      const px = x*scale;
      const py = y*scale;

      const t2 = t + 0.02;
      const x2 = 16*Math.pow(Math.sin(t2),3);
      const y2 = -(13*Math.cos(t2) - 5*Math.cos(2*t2) - 2*Math.cos(3*t2) - Math.cos(4*t2));
      const ang = Math.atan2((y2-y),(x2-x)) + Math.PI/2;

      stampHeart(ox, px, py, s, ang);
      if(i%3===0) stampHeart(ox, px*0.985, py*0.985, s, ang);
    }
    ox.restore();
  }

  let particles=[];
  function reinitParticlesToPoints(points){
    particles = new Array(points.length).fill(0).map((_,i)=>({
      x: Math.random()*W, y: Math.random()*H,
      vx:(Math.random()-0.5)*2, vy:(Math.random()-0.5)*2,
      tx: points[i].x, ty: points[i].y,
    }));
  }
  function disperse(){
    for(const p of particles){
      p.vx += (Math.random()-0.5)*CFG.disperseForce;
      p.vy += (Math.random()-0.5)*CFG.disperseForce;
    }
  }
  function stepParticles(k){
    const s = CFG.settleSpeed * k;
    for(const p of particles){
      const dx = p.tx - p.x;
      const dy = p.ty - p.y;
      p.vx = p.vx*0.86 + dx*s;
      p.vy = p.vy*0.86 + dy*s;
      p.x += p.vx; p.y += p.vy;
    }
  }
  function drawParticles(alpha=1){
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = CFG.particleColor;
    ctx.shadowColor = 'rgba(255,255,255,.20)';
    ctx.shadowBlur = 10;
    const r = CFG.particleRadius;
    for(const p of particles){
      ctx.beginPath();
      ctx.arc(p.x,p.y,r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  let scenes=[];
  function buildScenes(name){
    const isMobile = W < 700;
    const bigNum = isMobile ? Math.min(W,H)*0.36 : Math.min(W,H)*0.44;
    const wordSize = isMobile ? Math.floor(Math.min(W,H)*0.15) : Math.floor(Math.min(W,H)*0.19);

    const one   = makeTarget(()=>drawCenteredText('1', Math.floor(bigNum), H*0.50), 1.55);
    const two   = makeTarget(()=>drawCenteredText('2', Math.floor(bigNum), H*0.50), 1.55);
    const three = makeTarget(()=>drawCenteredText('3', Math.floor(bigNum), H*0.50), 1.55);

    const you = makeTarget(()=>drawCenteredText('you', wordSize, H*0.52), 1.35);
    const are = makeTarget(()=>drawCenteredText('are', wordSize, H*0.52), 1.35);
    const my  = makeTarget(()=>drawCenteredText('my',  wordSize, H*0.52), 1.35);
    const sunshine = makeTarget(()=>drawCenteredText('sunshine', wordSize, H*0.52), 1.22);

    const heart = makeTarget(()=>{
      const scale = isMobile ? Math.min(W,H)*0.014 : Math.min(W,H)*0.0175;
      drawHeartOfHearts(W/2, H*0.50, scale);

      const inside = isMobile ? Math.floor(Math.min(W,H)*0.055) : Math.floor(Math.min(W,H)*0.065);
      drawCenteredText('I Love You', inside, H*0.48, 'rgba(255,143,233,.98)', 900);
      drawCenteredText(name, Math.floor(inside*0.92), H*0.54, 'rgba(233,240,255,.95)', 800);
    }, 1.05);

    scenes = [one,two,three,you,are,my,sunshine,heart];
  }

  let t0=0, idx=-1, idxStart=0, shownFinal=false;
  const easeOutCubic = t => 1 - Math.pow(1-t,3);

  function idxAtTime(sec){
    const cuts = [
      CFG.d1,
      CFG.d1+CFG.d2,
      CFG.d1+CFG.d2+CFG.d3,
      CFG.d1+CFG.d2+CFG.d3+CFG.dy,
      CFG.d1+CFG.d2+CFG.d3+CFG.dy+CFG.da,
      CFG.d1+CFG.d2+CFG.d3+CFG.dy+CFG.da+CFG.dm,
      CFG.d1+CFG.d2+CFG.d3+CFG.dy+CFG.da+CFG.dm+CFG.ds
    ];
    if(sec < cuts[0]) return 0;
    if(sec < cuts[1]) return 1;
    if(sec < cuts[2]) return 2;
    if(sec < cuts[3]) return 3;
    if(sec < cuts[4]) return 4;
    if(sec < cuts[5]) return 5;
    if(sec < cuts[6]) return 6;
    return 7;
  }

  function showFinal(){
    if(shownFinal) return;
    shownFinal = true;
    finalOverlay.classList.add('show');
  }
  function hideFinal(){
    finalOverlay.classList.remove('show');
    shownFinal = false;
  }

  function restart(){
    hideFinal();
    const name = (document.getElementById('name').value || 'Mi Amor').trim().slice(0,24);
    buildScenes(name);
    idx = -1;
    idxStart = 0;
    t0 = performance.now();
  }

  function loop(now){
    drawMatrix();

    const elapsed = (now - t0)/1000;
    const next = idxAtTime(elapsed);

    if(next !== idx){
      idx = next;
      idxStart = elapsed;
      reinitParticlesToPoints(scenes[idx]);
      disperse();
    }

    const prog = Math.min(1, Math.max(0, (elapsed - idxStart) / CFG.buildTime));
    const k = 0.18 + 0.98 * easeOutCubic(prog);
    stepParticles(k);

    const alpha = 0.70 + 0.30 * easeOutCubic(prog);

    if(idx === 7){
      const pulse = 0.90 + 0.08*Math.sin(elapsed*2.0);
      drawParticles(Math.min(1, alpha * pulse));
      if((elapsed - idxStart) > CFG.heartHold) showFinal();
    }else{
      drawParticles(alpha);
    }

    requestAnimationFrame(loop);
  }

  // ===== EVENTOS =====
  const goBtn = document.getElementById('go');

  // ‚ñ∂ inicia animaci√≥n + m√∫sica (con desbloqueo)
  goBtn.addEventListener('click', async (e)=>{
    e.stopPropagation();
    await playMusic();
    restart();
  });

  // Primer toque/clic en pantalla: desbloquea audio y si wantsMusic=true, reproduce
  addEventListener('pointerdown', async (e)=>{
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
    if(tag === 'input' || tag === 'button') return;
    await gestureAudioKick();
    restart();
  }, {passive:true});

  // Estado inicial: m√∫sica apagada visualmente
  setMusicUI(false);

  resize();
  restart();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
